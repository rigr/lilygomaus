name: Build ESP32 Firmware

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🐍 Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: 📦 Cache PlatformIO
      uses: actions/cache@v3
      with:
        path: |
          ~/.platformio
          .pio
        key: ${{ runner.os }}-pio-${{ hashFiles('platformio.ini') }}
        restore-keys: |
          ${{ runner.os }}-pio-
          
    - name: 🔧 Install PlatformIO
      run: |
        python -m pip install --upgrade pip
        pip install platformio
        
    - name: 📋 Show Environment Info
      run: |
        pio --version
        pio system info
        
    - name: 🏗️ Build Firmware
      run: |
        echo "Starting build..."
        pio run
        echo "Build complete!"
        
    - name: 📊 Show Build Info
      run: |
        ls -lh .pio/build/lilygo-t-display/
        echo "---"
        pio run --target size
        
    - name: 📦 Prepare Artifacts
      run: |
        mkdir -p firmware
        cp .pio/build/lilygo-t-display/firmware.bin firmware/
        cp .pio/build/lilygo-t-display/bootloader.bin firmware/ 2>/dev/null || echo "No bootloader"
        cp .pio/build/lilygo-t-display/partitions.bin firmware/ 2>/dev/null || echo "No partitions"
        
    - name: 📤 Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: esp32-firmware
        path: firmware/
        retention-days: 90
